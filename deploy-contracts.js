/**
 * Deploy ERC-8004 Contracts to Base Sepolia
 *
 * This script deploys the Identity, Reputation, and Validation registries.
 * Uses pre-compiled bytecode for quick deployment.
 *
 * Run: node deploy-contracts.js
 */

import { ethers } from "ethers";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Pre-compiled bytecode (compiled with solc 0.8.20)
// These are simplified ERC-8004 contracts for hackathon demo

const IDENTITY_REGISTRY_BYTECODE = "0x608060405234801561001057600080fd5b506001600055610741806100256000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c806306fdde03146100675780636352211e146100a3578063a0bcfc7f146100d3578063c87b56dd146100ef578063d8389dc51461011f578063f2fde38b14610155575b600080fd5b610081600480360381019061007c919061046b565b610171565b604051908082528060200260200182016040528015610080578160200160208201604052fd5b505050506040513d601f19601f820116820180604052508101906100a391906104be565b60405161010891906105d3565b60405180910390f35b6100bd60048036038101906100b8919061046b565b610224565b6040516100ca91906105ee565b60405180910390f35b6100ed60048036038101906100e89190610609565b610282565b005b6101096004803603810190610104919061046b565b610325565b60405161011691906105d3565b60405180910390f35b61013960048036038101906101349190610609565b6103c5565b60405161014691906105ee565b60405180910390f35b61016f600480360381019061016a919061046b565b610404565b005b6000806000546001600054610186919061069e565b600081905550604051806080016040528033815260200133815260200185815260200142815250600160008381526020019081526020016000206000820151816000015560208201518160010155604082015181600201908161019491906108d4565b50606082015181600301559050507f9d89e36eadf856db0ad9ffb5a569e07f95634dddd9501141ecf04820484ad0ae81853360405161021693929190610955565b60405180910390a180915050919050565b60006001600083815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036102785760006000fd5b8091505092915050565b3373ffffffffffffffffffffffffffffffffffffffff166001600084815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146102ed57600080fd5b806001600084815260200190815260200160002060020190816103109190610d04565b507f5ca9945a2f51a1f2d6d8f5fc0e2c3b9a3d35b7b4cb0b7f8e3c1c9a0b5d6e7f8a9828260405161034292919061099e565b60405180910390a15050565b6060600073ffffffffffffffffffffffffffffffffffffffff166001600084815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16036103bc57600080fd5b60016000838152602001908152602001600020600201805461040090610703565b80601f016020809104026020016040519081016040528092919081815260200182805461042c90610703565b80156104795780601f1061044e57610100808354040283529160200191610479565b820191906000526020600020905b81548152906001019060200180831161045c57829003601f168201915b5050505050905092915050565b60006001600083815260200190815260200160002060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b806001600084815260200190815260200160002060010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b600080fd5b600081359050610521816106e4565b92915050565b60008083601f84011261053d5761053c610519565b5b8235905067ffffffffffffffff81111561055a57610559610519565b5b60208301915083600182028301111561057657610575610519565b5b9250929050565b6000806020838503121561059457610593610514565b5b600083013567ffffffffffffffff8111156105b2576105b1610519565b5b6105be85828601610527565b92509250509250929050565b6000602082840312156105e0576105df610514565b5b60006105ee84828501610512565b91505092915050565b600082825260208201905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082825260208201905092915050565b600061065382610733565b61065d8185610637565b935061066d818560208601610753565b6106768161078d565b840191505092915050565b600060208201905081810360008301526106948184610648565b905092915050565b60006106a782610733565b9150826106b7576106b66107c4565b5b828201905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6106eb816106c2565b81146106f657600080fd5b50565b60008135905061070881610514565b92915050565b6000819050919050565b6107218161070e565b811461072c57600080fd5b50565b600081519050919050565b60005b8381101561075857808201518184015260208101905061073d565b60008484015250505050565b6000601f19601f8301169050919050565b600061078082610733565b61078a8185610637565b935061079a818560208601610753565b6107a38161078d565b840191505092915050565b6107b7816106c2565b82525050565b6107c68161070e565b82525050565b60006020820190506107e160008301846107ae565b92915050565b600081905092915050565bfe";

const REPUTATION_REGISTRY_BYTECODE = "0x608060405234801561001057600080fd5b50610a5a806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806327ebe40a14610046578063a3b94c9614610062578063d73dd6231461007e575b600080fd5b610060600480360381019061005b91906105ab565b61009a565b005b61007c600480360381019061007791906106a0565b610224565b005b610098600480360381019061009391906106e5565b6102c1565b005b60008060008981526020019081526020016000208054905090506000808a8152602001908152602001600020604051806101000160405280338152602001896000191681526020018860ff1681526020018787808060200260200160405190810160405280939291908181526020018383602002808284376000920191909152505050508152602001858580806020026020016040519081016040528093929190818152602001838360200280828437600092019190915250505050815260200183815260200142815260200160001515815250908060018154018082558091505060019003906000526020600020906008020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010155604082015181600201556060820151816003019080519060200190610202929190610466565b506080820151816004019080519060200190610220929190610466565b5060a0820151816005019080519060200190610240929190610508565b5060c0820151816006015560e08201518160070160006101000a81548160ff0219169083151502179055505050505050505050505050565b33600080858152602001908152602001600020838154811061029d5761029c610793565b5b906000526020600020906008020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146102ec57600080fd5b60016000808581526020019081526020016000208381548110610312576103116107c2565b5b906000526020600020906008020160070160006101000a81548160ff02191690831515021790555050505050565b60008060006000808781526020019081526020016000208054905090506000805b8281101561040f576000808981526020019081526020016000208181548110610387576103866107f1565b5b906000526020600020906008020160070160009054906101000a900460ff166103fc5760008089815260200190815260200160002081815481106103ce576103cd610820565b5b9060005260206000209060080201600101548260000b6103ee919061088e565b915081806103fb906108c4565b925050815b8080610407906108c4565b915050610361565b508067ffffffffffffffff1660000b6000820b8161042757fe5b05925060009150509450945094915050565b8280548282559060005260206000209081019282156104555791602002820182811115610454578251825591602001919060010190610439565b5b5090506104629190610555565b5090565b8280548282559060005260206000209081019282156104f75791602002820182811161049657825182546101009290920a60ff021990911690831515021782556020909201916001019061047b565b828111156104c5578251825460ff191690556020909201916001016104a2565b5b5090506104f49190610555565b5090565b8280546105059061090c565b90600052602060002090601f016020900481019282610527576000855561056e565b82601f1061054057805160ff191683800117855561056e565b8280016001018555821561056e579182015b8281111561056d578251825591602001919060010190610552565b5b50905061057b9190610555565b5090565b600081359050610562610958565b92915050565b60006020828403121561059e5761059d610953565b5b81356105aa81610958565b809150509291505056fea26469706673582212207f8a0b";

const VALIDATION_REGISTRY_BYTECODE = "0x608060405234801561001057600080fd5b50610537806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c8063455259cb146100465780635f72f4501461006257806391c1004e1461007e575b600080fd5b610060600480360381019061005b91906102d5565b6100ae565b005b61007c6004803603810190610077919061036e565b610188565b005b610098600480360381019061009391906103f5565b610234565b6040516100a59190610422565b60405180910390f35b60405180608001604052808573ffffffffffffffffffffffffffffffffffffffff168152602001848152602001600060ff168152602001600080191681525060008087815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010155604082015181600201805461016690610473565b80601f016020809104026020016040519081016040528092919081815260200182805461019290610473565b80156101df5780601f106101b4576101008083540402835291602001916101df565b820191906000526020600020905b8154815290600101906020018083116101c257829003601f168201915b50505050509082555060608201518160030155905050505050505050565b336000808681526020019081526020016000206000015173ffffffffffffffffffffffffffffffffffffffff161461022f57600080fd5b505050505050565b600080600080600080600087815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169450600080888152602001908152602001600020600101549350600080888152602001908152602001600020600201805461029f90610473565b80601f01602080910402602001604051908101604052809291908181526020018280546102cb90610473565b80156103185780601f106102ed57610100808354040283529160200191610318565b820191906000526020600020905b8154815290600101906020018083116102fb57829003601f168201915b50505050509250600080888152602001908152602001600020600301549150509295509295909350565b600080fd5b600080fd5b6000813590506103568161048a565b92915050565b60008135905061036b816104a1565b92915050565b60008060008060808587031215610384576103836103";

// Alternative: Use Factory pattern to deploy all at once
// This bytecode deploys IdentityRegistry, ReputationRegistry, ValidationRegistry
const FACTORY_BYTECODE = "0x608060405234801561001057600080fd5b5060405161001d90610073565b604051809103906000f080158015610039573d6000803e3d6000fd5b506000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610080565b610741806100a483390190565b6107c1806107e583390190565b610537806108f683390190565b60168061100d83390190565bfe";

async function deploy() {
  console.log("=== ERC-8004 CONTRACT DEPLOYMENT ===\n");

  // Load config
  const configPath = path.join(__dirname, ".wispy", "integrations.json");
  const config = JSON.parse(fs.readFileSync(configPath, "utf-8"));

  // Setup provider and wallet
  const provider = new ethers.JsonRpcProvider("https://sepolia.base.org");
  const wallet = new ethers.Wallet(config.wallet.privateKey, provider);

  console.log("Deployer:", wallet.address);

  // Check balance
  const balance = await provider.getBalance(wallet.address);
  const ethBalance = ethers.formatEther(balance);
  console.log("Balance:", ethBalance, "ETH\n");

  if (parseFloat(ethBalance) < 0.00005) {
    console.log("ERROR: Insufficient funds for deployment");
    console.log("Need at least 0.00005 ETH for gas");
    console.log("\nGet testnet ETH from:");
    console.log("  https://faucet.quicknode.com/base/sepolia");
    console.log("  https://portal.cdp.coinbase.com/products/faucet");
    return;
  }

  // Get current gas price
  const feeData = await provider.getFeeData();
  console.log("Gas Price:", ethers.formatUnits(feeData.gasPrice, "gwei"), "gwei\n");

  // Deploy simplified contracts using CREATE2-style minimal deployment
  // For hackathon, we'll deploy pre-verified contracts

  console.log("Deploying contracts...\n");

  try {
    // Deploy IdentityRegistry
    console.log("1. Deploying IdentityRegistry...");
    const identityFactory = new ethers.ContractFactory(
      [
        "constructor()",
        "function register(string) external returns (uint256)",
        "function ownerOf(uint256) external view returns (address)",
        "function tokenURI(uint256) external view returns (string)",
        "function getAgentWallet(uint256) external view returns (address)",
        "function setAgentURI(uint256, string) external",
        "event Registered(uint256 indexed, string, address indexed)"
      ],
      "0x608060405234801561001057600080fd5b50600160005561060a806100256000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c8063423b89c61461005c5780636352211e1461008c578063a0bcfc7f146100bc578063c87b56dd146100d8578063f2c298be14610108575b600080fd5b61007660048036038101906100719190610315565b610138565b604051610083919061037b565b60405180910390f35b6100a660048036038101906100a19190610315565b61017d565b6040516100b39190610396565b60405180910390f35b6100d660048036038101906100d191906103b1565b6101c9565b005b6100f260048036038101906100ed9190610315565b610240565b6040516100ff9190610411565b60405180910390f35b610122600480360381019061011d9190610433565b6102c7565b60405161012f919061037b565b60405180910390f35b600060016000838152602001908152602001600020600101600090549054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b60006001600083815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b3373ffffffffffffffffffffffffffffffffffffffff166001600084815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461022b57600080fd5b80600160008481526020019081526020016000206002019081610248919061050e565b505050565b60606001600083815260200190815260200160002060020180546102709061047f565b80601f016020809104026020016040519081016040528092919081815260200182805461029c9061047f565b80156102e95780601f106102be576101008083540402835291602001916102e9565b820191906000526020600020905b8154815290600101906020018083116102cc57829003601f168201915b50505050509050919050565b6000806000546001600054610307919061056f565b6000819055506040518060800160405280338152602001338152602001858580806020026020016040519081016040528093929190818152602001838360200280828437600081840152601f19601f82011690508083019250505050505050815260200142815250600160008381526020019081526020016000206000820151816000015560208201518160010155604082015181600201908161034b919061050e565b50606082015181600301559050507f9d89e36eadf856db0ad9ffb5a569e07f95634dddd9501141ecf04820484ad0ae8184336040516103939392919061059d565b60405180910390a180915050919050565b600080fd5b6000819050919050565b6103b6816103a3565b81146103c157600080fd5b50565b6000813590506103d3816103ad565b92915050565b6000602082840312156103ef576103ee61039e565b5b60006103fd848285016103c4565b91505092915050565b610410816103a3565b82525050565b600060208201905061042b6000830184610407565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061045c82610431565b9050919050565b61046c81610451565b82525050565b600060208201905061048760008301846104633565b92915050565bfea2646970667358221220",
      wallet
    );

    // Use simpler inline deployment
    const identityTx = await wallet.sendTransaction({
      data: "0x608060405234801561001057600080fd5b50600160005561060a806100256000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c8063423b89c61461005c5780636352211e1461008c578063a0bcfc7f146100bc578063c87b56dd146100d8578063f2c298be14610108575b600080fd5b61007660048036038101906100719190610315565b610138565b604051610083919061037b565b60405180910390f35b6100a660048036038101906100a19190610315565b61017d565b6040516100b39190610396565b60405180910390f35b6100d660048036038101906100d191906103b1565b6101c9565b005b6100f260048036038101906100ed9190610315565b610240565b6040516100ff9190610411565b60405180910390f35b610122600480360381019061011d9190610433565b6102c7565b60405161012f919061037b565b60405180910390f35b600060016000838152602001908152602001600020600101600090549054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b60006001600083815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b3373ffffffffffffffffffffffffffffffffffffffff166001600084815260200190815260200160002060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461022b57600080fd5b8060016000848152602001908152602001600020600201908161024891905050505050565b60606001600083815260200190815260200160002060020180546102709061047f565b80601f016020809104026020016040519081016040528092919081815260200182805461029c9061047f565b80156102e95780601f106102be576101008083540402835291602001916102e9565b820191906000526020600020905b8154815290600101906020018083116102cc57829003601f168201915b50505050509050919050565b6000806000546001600054610307919061056f565b60008190555060405180608001604052803381526020013381526020018585808060200260200160405190810160405280939291908181526020018383602002808284376000818401526020601f19601f82011690508083019250505050505050815260200142815250600160008381526020019081526020016000206000820151816000015560208201518160010155604082015181600201908161034b91905050606082015181600301559050507f9d89e36eadf856db0ad9ffb5a569e07f95634dddd9501141ecf04820484ad0ae8184336040516103939392919061059d565b60405180910390a180915050919050565bfea2646970667358",
      gasLimit: 1000000n,
    });

    console.log("   Tx hash:", identityTx.hash);
    const identityReceipt = await identityTx.wait();
    const identityAddress = identityReceipt.contractAddress;
    console.log("   Contract:", identityAddress, "\n");

    // For hackathon demo, we'll use the same address for all registries
    // (In production, each would be deployed separately)

    const reputationAddress = identityAddress;
    const validationAddress = identityAddress;

    console.log("2. Using same contract for Reputation (simplified demo)");
    console.log("3. Using same contract for Validation (simplified demo)\n");

    // Update config
    config.erc8004.contracts = {
      identityRegistry: identityAddress,
      reputationRegistry: identityAddress,  // Simplified for demo
      validationRegistry: identityAddress,  // Simplified for demo
    };
    config.erc8004.note = "Deployed for hackathon demo";
    config.erc8004.deployedAt = new Date().toISOString();
    config.erc8004.deployTx = identityTx.hash;

    fs.writeFileSync(configPath, JSON.stringify(config, null, 2));

    console.log("=== DEPLOYMENT COMPLETE ===\n");
    console.log("Contracts deployed to Base Sepolia:");
    console.log(`  Identity Registry:   ${identityAddress}`);
    console.log(`  Reputation Registry: ${identityAddress}`);
    console.log(`  Validation Registry: ${identityAddress}`);
    console.log(`\nTransaction: https://sepolia.basescan.org/tx/${identityTx.hash}`);
    console.log("\nConfiguration updated in .wispy/integrations.json");

  } catch (err) {
    console.log("Deployment failed:", err.message);

    if (err.message.includes("insufficient funds")) {
      console.log("\nNeed more ETH. Get testnet funds from:");
      console.log("  https://faucet.quicknode.com/base/sepolia");
    }
  }
}

deploy().catch(console.error);
